---
title: "Introduction"
output: volker::html_report
vignette: >
  %\VignetteIndexEntry{Introduction}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---

```{r include=FALSE}
knitr::opts_chunk$set(
  echo = F,
  knitr.table.format = "html"
)
```


```{r include=FALSE}
library(tidyverse)
library(volker)
```


```{r include=FALSE}
# Checking all plots 

theme_set(theme_vlkr(base_fill = c("grey"))) 

tab_counts_one(ds, sd_gender)
# Counts 
plot_counts_one(ds, sd_gender, numbers = T) 
plot_counts_items(ds, starts_with("cg_adoption_"), numbers = T)
plot_counts_one_grouped(ds, adopter, sd_gender)
plot_counts_items_grouped(ds, ...) # not implemented 

# Metrics
plot_metrics_one(ds, sd_age, numbers =T) # add mean? 
plot_metrics_one_grouped(ds, sd_age, sd_gender, bars = "box")
plot_metrics_items(ds, starts_with("cg_adoption"))
plot_metrics_items_grouped(ds, starts_with("cg_adoption_"), sd_gender) # not working 

t.test(ds$sd_age)

[1] 131.1 261.6
```


```{r include=FALSE}

stat_counts_one(ds, sd_age)
```

```{r}
# Load data 
ds <- volker::chatgpt

# Playground lm 

fit <- stats::lm(sd_age ~ adopter, data = ds)

leveneTest(fit)
shapiro.test(ds$sd_age,ds$adopter)

# Metrics for innovator type items 
tab_metrics_one_grouped(ds, sd_age, adopter)

# Stats table (regression)
# TODO: Fix labels and add another table that shows overall model stats (e.g.R^2)
stat_metrics_one_grouped(ds, sd_age, adopter)

# Plot metrics without stats 
volker::plot_metrics_one_grouped(ds, sd_age, adopter)

# Plot metrics with stats and numbers
plot_metrics_one_grouped(ds, sd_age, adopter, stats = T, numbers = T)
```


```{r}

volker::tab_counts_items(ds, starts_with("adopt"))

# confidence interval for mean 
t.test(ds$sd_age)$conf.int

df <- data.frame(
  ID = 1:6,
  Value1 = c(10, -5, 8, -3, 12,NA),
  Value2 = c(-7, 6, 9, -2, 15,NA), 
  Value3 = c("hallo", "ne", "garnicht", "gehtso", "no", NA)
)

stat_metrics_one_grouped(df, Value1,  Value3, missings = F)
tab_metrics(df, Value)

plot_counts_one_grouped(df, Value3, Value2, missing = T)
plot_counts_items(ds, starts_with("cg_adoption"), missing =T)
plot_metrics_one(df, Value1, negative = T)
stat_metrics_one_grouped(ds, cg_adoption_advantage_01, sd_gender, missings = F)

tab_counts_one(ds, sd_gender)

ds <- volker::chatgpt


result <- ds %>%
    dplyr::count(sd_gender) %>%
    tidyr::drop_na() %>%
    dplyr::mutate("sd_gender" := as.character(sd_gender)) %>% 
    dplyr::mutate(p = n / sum(n)) # %>% 

    # calculate gini
    # TODO: Correct for frequencies?

result <- result %>%  
    dplyr::arrange(n) %>% 
    dplyr::mutate(cumulative_frequencies = cumsum(n),
           cumulative_percentage = cumulative_frequencies / sum(n)) %>%
    summarize(gini = (length(n) + 1 - 
                      2 * sum(cumulative_percentage * n / sum(n))) / 
                      length(n)) 


# Anzahl der Beobachtungen
total_obs <- sum(result$n)

num_groups <- nrow(result)

z_value <- qnorm(1 - (1 - 0.95) / 2)

# Confidence Intervals berechnen
result <- result %>%
  mutate(
    std_error = sqrt(p * (1 - p) / total_obs),
    ci_lower = p - z_value * std_error,
    ci_upper = p + z_value * std_error
  ) 


Gini()

```


```{r}

# Playground 
# perform chi^2 test 

c <- chisq.test(ds$sd_gender, ds$adopter)


z <- cramers_v(c, adjust = F)

tab_metrics_items_cor(ds, starts_with("cg_adoption_adv"))

temp <- tibble(ds$sd_gender, ds$adopter)
temp <- ds %>% 
  group_by(sd_gender) %>% 
  count()

# contingency table 

table(ds$sd_gender, ds$adopter)

temp <- ds %>%
  count(adopter, sd_gender) %>% 
  spread(sd_gender, n, fill = 0) 

temp <- ds %>%
  count(adopter, sd_gender) %>% 
  spread(sd_gender, n) 

temp <- ds %>%
  count(adopter, sd_gender) %>% 
  spread(sd_gender, n, fill = 0) %>%  
  as.data.frame() %>%
  select(-1) %>% 
  chisq.test()

chisq.test(temp)

z <- ds %>%  
  count(sd_gender, adopter)

# Playground 
# plot scatterplot or heatmap 

tab_metrics_items_cor(ds, starts_with("cg_adoption_adv"))

# Scatter

ds %>% 
  ggplot(aes(x = cg_adoption_advantage_04, y = cg_adoption_advantage_02)) +
  geom_point() +
  labs(title = "Scatterplot", x = "X-axis", y = "Y-axis")

# Heatmap

cor <- ds %>% 
  select(cg_adoption_advantage_04,cg_adoption_advantage_02) %>% 
  stats::cor() %>% 
  reshape2::melt()

 cor %>% 
ggplot(aes(x=Var1, y=Var2, fill=value)) + 
  geom_tile()
  



```


```{r}

stat_counts_one_grouped(ds, cg_adoption_advantage_01, sd_gender, missings= T)

report_counts(ds, cg_adoption_advantage_01, sd_gender, stats = T)

report_metrics(ds, sd_age, adopter, stats = T)

```


```{r}
