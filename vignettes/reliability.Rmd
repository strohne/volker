---
title: "Reliability and classification performance indicators"
output: volker::html_report
vignette: >
  %\VignetteIndexEntry{Reliability}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---

```{r include=FALSE}
knitr::opts_chunk$set(echo = F)

library(tidyverse)
library(volker)
```

```{r}

# Load data 
data <- volker::chatgpt

# Code some data for reliability calculations
data_coder1 <- data |> 
  select(case, cg_activities) |> 
  mutate(cg_activities = tolower(cg_activities)) |> 
  mutate(
    topic_write = str_detect(cg_activities, "texte|schreiben|formulieren"),
    topic_search = str_detect(cg_activities, "suche|informationen|suchmaschine|frage"),
    topic_test = str_detect(cg_activities, "probier|spass|freude|langeweile"),
    coder="c1"
  )

data_coder2 <- data |> 
  select(case, cg_activities) |> 
  mutate(cg_activities = tolower(cg_activities)) |> 
  mutate(
    topic_write = str_detect(cg_activities, "texte|schreiben|verfass|uerbersetz"),
    topic_search = str_detect(cg_activities, "such|informationen|frage"),
    topic_test = str_detect(cg_activities, "probier|spass|freude|idee|interesse|frage"),
    coder="c2"
  )

data_coded <- bind_rows(
  data_coder1,
  data_coder2
)


```


## Using report_counts()

```{r}

# TODO: Add confusion matrix or something similar
# TODO: Output agreement in plots / tables (c11 & c2, c1 only, c2 only)
report_counts(data_coded, topic_write, coder, ids = case, prop="cells", agree = "reli")
report_counts(data_coded, starts_with("topic_"), coder, ids = case, agree = "reliability")

```

## 1. Reliability for a single item
```{r}

agree_tab(data_coded, topic_write, coder, ids = case, method="reli")

```


## 2. Reliability for multiple items
```{r}

agree_tab(data_coded, starts_with("topic_"), coder, ids = case, method="reliability")

```



## 3. F1 for a single item
```{r}

agree_tab(data_coded, topic_write, coder, ids = case, method="classification")

```


## 4. F1 for multiple items
```{r}

agree_tab(data_coded, starts_with("topic_"), coder, ids = case, method="classification")

```


## 5. Choosing macro statistics vs. single categories
```{r}

# There are three cases to consider:
# - If you provide a category in the respective parameter,
#   results relate to this category. 
# - If you omit the parameter (or set it to null) and you have boolean values,
#   the TRUE category is automatically choosen.
# - Otherwise, macro statistics for precision, recall, and f1 are calculated by
#   averaging over the results of all categories. You will find the number of categories
#   in the result table.

data_coded %>% 
  mutate(across(starts_with("topic_"), ~ ifelse(., "yes", "no"))) %>% 
  agree_tab(starts_with("topic_"), coder, ids = case, method = "classification", category = "no")

```

