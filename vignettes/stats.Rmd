---
title: "Introduction"
output: volker::html_report
vignette: >
  %\VignetteIndexEntry{Introduction}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---

```{r include=FALSE}
knitr::opts_chunk$set(
  echo = F,
  knitr.table.format = "html"
)

library(tidyverse)
library(volker)
```

```{r}
# Load data 
ds <- volker::chatgpt

# Metrics for innovator type items 

tab_metrics_one_grouped(ds, sd_age, adopter)

# Stats table 
# TODO: Fix labels and add another table that shows overall model stats (e.g.R^2)
stats_metrics_one_grouped(ds, sd_age, adopter)

# Plot metrics with stats 
# TODO: implement stats parameter, so if true errorbars are shown 

plot_metrics_one_grouped(ds, sd_age, adopter, stats=T)

plot_metrics_one_grouped(ds, sd_age, adopter)

fit <- lm(sd_age ~ adopter, data=ds)
library(broom)
y <-glance(fit)
summary(fit)

x <- tidy(fit)
confint(fit)

# library(broom)
# tidy(fit)
# glance(fit)

ests <- stats_metrics_one_grouped(ds, sd_age, adopter)
int <- ests$estimate[[1]]
ests <- ests |> 
  mutate(m = case_when(
      term == "(Intercept)" ~ estimate,
      TRUE ~  int + estimate
    )
  )
# TODO: use confint 
# das hei√üt vorher confint berechnen und dann reinbringen, 
# dann das ganze in Funktion uebertragen 
ggplot(ests , aes(x = m, y=term)) +
  geom_point() +
  geom_errorbar(aes(xmin = m -1.96 * std.error, xmax = m + 1.96 * std.error))

library(ggpubr)
# using stat_summary 
ggplot(ds, aes(x = sd_age, y=adopter)) +
  stat_summary(geom = "point", fun = mean)+ 
  stat_summary(geom = "errorbar", fun.data = mean_ci)

# n for condition "i only use new offers when no other choice"
# equals 1; NaNs are coerced 

# own confidence interval calculation 

sum <- ds %>%
  group_by(adopter) %>%
  summarise( 
    n=n(),
    mean=mean(sd_age),
    sd=sd(sd_age)
  ) %>%
  mutate(se=sd/sqrt(n))  %>%
  mutate(ic=se * qt((1-0.05)/2 + .5, n-1))
  
 sum %>%  
  ggplot(aes(y=adopter, x=mean)) +
   geom_point() +
   geom_errorbar(aes(xmin=mean-ic, xmax=mean+ic))
 
```


```{r}

# function using ggpubr for confidence intervals 

temp <- function(data, col, col_group, limits = NULL, negative = FALSE, stats = FALSE, title = TRUE, labels = TRUE, clean = TRUE, ...) {

  # 1. Check parameters
  check_is_dataframe(data)
  check_has_column(data, {{ col }})
  check_has_column(data, {{ col_group }})

  # 2. Clean
  if (clean) {
    data <- data_clean(data)
  }

  # Remove negative values
  # TODO: warn if any negative values were recoded
  if (!negative) {
    data <- data |>
      labs_store() |>
      dplyr::mutate(dplyr::across({{ col }}, ~ ifelse(. < 0, NA, .))) |>
      labs_restore()
  }

  # Drop missings
  # TODO: Report missings
  data <- tidyr::drop_na(data, {{ col }}, {{ col_group }})

  if (stats) {
    
  pl <- data %>%
    ggplot2::ggplot(ggplot2::aes(y={{ col }}, {{ col_group}})) +
    ggplot2::stat_summary(geom = "point", fun = mean, colour = VLKR_POINTCOLOR) + 
    ggplot2::stat_summary(geom = "errorbar", fun.data = ggpubr::mean_ci)
  } else {

  pl <- data %>%
    ggplot2::ggplot(ggplot2::aes(y={{ col_group }}, {{ col }})) +
    ggplot2::geom_boxplot(fill="transparent", color="darkgray") +
    ggplot2::stat_summary(fun = mean, geom="point",colour=VLKR_POINTCOLOR, size=4, shape=18) 
  }
  
  .to_vlkr_plot(pl)
}

temp(ds, sd_age, adopter, stats = T)

```


```{r}
# function using own calculation 

temp2 <- function(data, col, col_group, limits = NULL, negative = FALSE, stats = FALSE, title = TRUE, labels = TRUE, clean = TRUE, ...) {

  # 1. Check parameters
  check_is_dataframe(data)
  check_has_column(data, {{ col }})
  check_has_column(data, {{ col_group }})

  # 2. Clean
  if (clean) {
    data <- data_clean(data)
  }

  # Remove negative values
  # TODO: warn if any negative values were recoded
  if (!negative) {
    data <- data |>
      labs_store() |>
      dplyr::mutate(dplyr::across({{ col }}, ~ ifelse(. < 0, NA, .))) |>
      labs_restore()
  }

  # Drop missings
  # TODO: Report missings
  data <- tidyr::drop_na(data, {{ col }}, {{ col_group }})

  if (stats) {
    
  data <- data %>%  
    group_by({{ col_group }}) %>%
  summarise( 
    n=n(),
    mean=mean({{ col }}),
    sd=sd({{ col }})
  ) %>%
  mutate(se=sd/sqrt(n))  %>%
  mutate(ic=se * qt((1-0.05)/2 + .5, n-1))
    
  pl <- data %>%
    ggplot2::ggplot(ggplot2::aes(y={{ col_group }}, x=mean)) +
    ggplot2::geom_point(colour=VLKR_POINTCOLOR) +
    ggplot2::geom_errorbar(aes(xmin=mean-ic, xmax=mean+ic))
  
  } else {

  pl <- data %>%
    ggplot2::ggplot(ggplot2::aes(y={{ col_group }}, {{ col }})) +
    ggplot2::geom_boxplot(fill="transparent", color="darkgray") +
    ggplot2::stat_summary(fun = mean, geom="point",colour=VLKR_POINTCOLOR, size=4, shape=18)
  }
  
  .to_vlkr_plot(pl)
}

temp2(ds, sd_age, adopter, stats = T)

```


```{r}

# function using ggpubr with stats_compare_means 

temp3 <- function(data, col, col_group, limits = NULL, negative = FALSE, stats = FALSE, title = TRUE, labels = TRUE, clean = TRUE, ...) {

  # 1. Check parameters
  check_is_dataframe(data)
  check_has_column(data, {{ col }})
  check_has_column(data, {{ col_group }})

  # 2. Clean
  if (clean) {
    data <- data_clean(data)
  }

  # Remove negative values
  # TODO: warn if any negative values were recoded
  if (!negative) {
    data <- data |>
      labs_store() |>
      dplyr::mutate(dplyr::across({{ col }}, ~ ifelse(. < 0, NA, .))) |>
      labs_restore()
  }

  # Drop missings
  # TODO: Report missings
  data <- tidyr::drop_na(data, {{ col }}, {{ col_group }})

  if (stats) {
    
    pl <- data %>%
    ggplot2::ggplot(ggplot2::aes(y={{ col }}, {{ col_group}})) +
  ggplot2::stat_summary(geom = "point", fun = mean, colour = VLKR_POINTCOLOR) + 
    ggplot2::stat_summary(geom = "errorbar", fun.data = ggpubr::mean_ci) + ggpubr::stat_compare_means()
  
  } else {

  pl <- data %>%
    ggplot2::ggplot(ggplot2::aes(y={{ col_group }}, {{ col }})) +
    ggplot2::geom_boxplot(fill="transparent", color="darkgray") +
    ggplot2::stat_summary(fun = mean, geom="point",colour=VLKR_POINTCOLOR, size=4, shape=18)
  }
  
  .to_vlkr_plot(pl)
}

# ds <- ds %>% 
#  filter(adopter != "I only use new offers when I have no other choice", 
#        sd_gender != "diverse") 

temp3(ds, sd_age,adopter,stats = T)

```

