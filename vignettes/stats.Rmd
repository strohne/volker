---
title: "Introduction"
output: volker::html_report
vignette: >
  %\VignetteIndexEntry{Introduction}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---

```{r include=FALSE}
knitr::opts_chunk$set(
  echo = F,
  knitr.table.format = "html"
)

library(tidyverse)
library(volker)
```

```{r}

# Load data 
ds <- volker::chatgpt

fit <- stats::lm(sd_age ~ adopter, data = ds)

# Metrics for innovator type items 
tab_metrics_one_grouped(ds, sd_age, adopter)

# Stats table (regression)
# TODO: Fix labels and add another table that shows overall model stats (e.g.R^2)
stat_metrics_one_grouped(ds, sd_age, adopter)

# Plot metrics without stats 
volker::plot_metrics_one_grouped(ds, sd_age, adopter)

# Plot metrics with stats and numbers
plot_metrics_one_grouped(ds, sd_age, adopter, stats=T, numbers = T)

```


```{r}
# Playground 
# perform chi^2 test 

c <- chisq.test(ds$sd_gender, ds$adopter)

z <- cramers_v(c, adjust = F)

temp <- tibble(ds$sd_gender, ds$adopter)
temp <- ds %>% 
  group_by(sd_gender) %>% 
  count()

# contingency table 

table(ds$sd_gender, ds$adopter)

temp <- ds %>%
  count(adopter, sd_gender) %>% 
  spread(sd_gender, n, fill = 0) 

temp <- ds %>%
  count(adopter, sd_gender) %>% 
  spread(sd_gender, n) 

temp <- ds %>%
  count(adopter, sd_gender) %>% 
  spread(sd_gender, n, fill = 0) %>%  
  as.data.frame() %>%
  select(-1) %>% 
  chisq.test()

chisq.test(temp)

?xtabs()
as_tibble()

z <- ds %>%  
  count(sd_gender, adopter)
  
xtab <- xtabs(n ~ adopter + sd_gender, z)

stats::chisq.test(xtab)

```


```{r}

# Function using own calculation 
# @Jakob: Adjustierung für kleine samples? Konfidenzintervall hinzufügen? Alternative: Package effectsize verwenden (s.u.)
# @Jakob: Übergeben an .to_vlkr_tab... i need help with that 

stat_counts_one_grouped <- function(data, col, col_group, missings = FALSE, clean = TRUE, ...) {
  
  # 1. Check parameters
  check_is_dataframe(data)
  check_has_column(data, {{ col }})
  check_has_column(data, {{ col_group }})
  
  # 2. Clean
  if (clean) {
    data <- data_clean(data)
  }
  
  # Remove missings
  # TODO: output a warning
  if (!missings) {
    data <- data %>%
      tidyr::drop_na({{ col }}, {{ col_group }})
  }
  
  # Chi-squared test
  contingency <- data %>%
    count({{ col }}, {{ col_group }}) %>%
    spread({{ col_group }}, n, fill = 0) %>%
    
    # note: transformation due to incompatibility with chisq.test
    as.data.frame() %>%
    select(-1) %>%
    as.matrix()
  
  test <- stats::chisq.test(contingency)
  
  # Calculate Cramer's V
  n <- sum(contingency)
  phi <- sqrt(test$statistic / n)
  
  levels_col <- data %>%
    dplyr::distinct({{ col }}) %>%
    nrow()
  
  levels_col_group <- data %>%
    dplyr::distinct({{ col_group }}) %>%
    nrow()
  
  cramer_v <- phi / sqrt(min(levels_col, levels_col_group) - 1)
  
  # print
  
  print(test)
  cat("\n")
  cat("Cramer's V:", cramer_v, "\n")
  
}

stat_counts_one_grouped(ds, adopter, sd_gender)

```


```{r}

temp <- function(data, col, col_group, missings = FALSE, clean = TRUE, ...) {
  
  # 1. Check parameters
  check_is_dataframe(data)
  check_has_column(data, {{ col }})
  check_has_column(data, {{ col_group }})
  
  # 2. Clean
  if (clean) {
    data <- data_clean(data)
  }
  
  # Remove missings
  # TODO: output a warning
  if (!missings) {
    data <- data %>%
      tidyr::drop_na({{ col }}, {{ col_group }})
  }
  
  # Chi-squared test
  data <- data %>%
    dplyr::count({{ col }}, {{ col_group }}) %>%
    tidyr::spread({{ col_group }}, n, fill = 0) %>%
    
    # Note: transformation due to incompatibility with chisq.test
    as.data.frame() %>%
    select(-1) %>%
    as.matrix()
  
  test <- stats::chisq.test(data)
  
  # Calculate Cramer's V
  cramer_v <- effectsize::cramers_v(test, adjust = F, )
  
  # Print results
  print(test)
  cat("\n")
  cat("Cramer's V:", cramer_v$Cramers_v, "\n")
  
}

temp(ds, adopter, sd_gender)


```
