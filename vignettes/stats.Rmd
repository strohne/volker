---
title: "Introduction"
output: volker::html_report
vignette: >
  %\VignetteIndexEntry{Introduction}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---

```{r include=FALSE}
knitr::opts_chunk$set(
  echo = F,
  knitr.table.format = "html"
)

library(tidyverse)
library(volker)
```

```{r}

# Load data 
ds <- volker::chatgpt

tab_metrics_items_cor(starts_with("cg_adoption_adv"), data= ds)

# Metrics for innovator type items 

tab_metrics_one_grouped(ds, sd_age, adopter)

# Stats table (regression)
# TODO: Fix labels and add another table that shows overall model stats (e.g.R^2)
volker::stats_metrics_one_grouped(ds, sd_age, adopter)

# Plot metrics without stats 
volker::plot_metrics_one_grouped(ds, sd_age, adopter)

# Plot metrics with stats and numbers
plot_metrics_one_grouped(ds, sd_age, adopter, stats=T, numbers = T)

```


```{r}
# Playground perform chi^2 test 

grouped <- ds %>%
    dplyr::count(sd_gender, adopter)

chisq.test(ds$sd_gender, ds$adopter)

tab_counts_items(ds, starts_with("cg_adoption_"))


temp <- tibble(ds$sd_gender, ds$adopter)
temp <- temp %>% 
  group_by(ds$sd_gender) %>% 
  count()

table(ds$sd_gender, ds$adopter)

# contingency table 

x <- ds %>%
  group_by(sd_gender, adopter)%>%
  summarise(n=n())#%>%
  spread(adopter, n)

z <- ds %>%  
  count(sd_gender, adopter)
  
xtab <- xtabs(n ~ adopter + sd_gender, z)

stats::chisq.test(xtab)

y <- stats::chisq.test(ds$sd_gender, ds$adopter)

M <- as.table(rbind(c(762, 327, 468), c(484, 239, 477)))
dimnames(M) <- list(gender = c("F", "M"),
                    party = c("Democrat","Independent", "Republican"))

library(gmodels)
CrossTable(ds$sd_gender, ds$adopter)
```


```{r}
stats_counts_one_grouped <- function(data, col, col_group, missings = FALSE, prop = "total", values = c("n", "p"), percent = TRUE, labels = TRUE, clean = TRUE, ...) {
  
  # 1. Check parameters
  check_is_dataframe(data)
  check_has_column(data, {{ col }})
  check_has_column(data, {{ col_group }})
  
  # 2. Clean
  if (clean) {
    data <- data_clean(data)
  }
  
  # Remove missings
  # TODO: output a warning
  if (!missings) {
    data <- data %>%
      tidyr::drop_na({{ col }}, {{ col_group }})
  }
  
  #
  # 1. Count
  #
  result <- data %>%
    dplyr::count({{ col }}, {{ col_group }}) %>%
    dplyr::mutate(
      "{{ col_group }}" := tidyr::replace_na(as.character({{ col_group }}), "Missing"),
      "{{ col }}" := tidyr::replace_na(as.character({{ col }}), "Missing")
    ) %>%  
    tidyr::spread({{ col_group }}, n) 
  
  
  .to_vlkr_tab(result, digits=0)

}

stats_counts_one_grouped(ds, adopter, sd_gender)
```


```{r}

DF <- as.data.frame(UCBAdmissions)
## Now 'DF' is a data frame with a grid of the factors and the counts
## in variable 'Freq'.
DF
## Nice for taking margins ...
hi <- xtabs(Freq ~ Gender + Admit, DF)
chisq.test(hi)

## And for testing independence ...
summary(xtabs(Freq ~ ., DF))


```
